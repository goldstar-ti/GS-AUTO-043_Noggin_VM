{% extends "base.html" %}

{% block title %}Inspection {{ inspection.noggin_reference }} - Noggin Processor{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Inspection Details: {{ inspection.noggin_reference or inspection.tip }}</h2>
        <div>
            {% set status_class = {
                'complete': 'success',
                'pending': 'info',
                'failed': 'danger',
                'partial': 'warning',
                'api_error': 'danger',
                'csv_imported': 'secondary'
            }.get(inspection.processing_status, 'secondary') %}
            <span class="badge {{ status_class }}" style="font-size: 1rem;">{{ inspection.processing_status|upper }}</span>
        </div>
    </div>
    
    <table>
        <tr>
            <th>LCD Inspection ID</th>
            <td>{{ inspection.noggin_reference or 'N/A' }}</td>
        </tr>
        <tr>
            <th>Object Type</th>
            <td>{{ inspection.object_type }}</td>
        </tr>
        <tr>
            <th>Inspection Date</th>
            <td>{{ inspection.inspection_date.strftime('%d-%m-%Y') if inspection.inspection_date else 'N/A' }}</td>
        </tr>
        <tr>
            <th>Vehicle</th>
            <td>{{ inspection.vehicle or 'N/A' }}</td>
        </tr>
        <tr>
            <th>Trailer</th>
            <td>{{ inspection.trailer or 'N/A' }}</td>
        </tr>
        <tr>
            <th>Department</th>
            <td>{{ inspection.department or 'N/A' }}</td>
        </tr>
        <tr>
            <th>Team</th>
            <td>{{ inspection.team or 'N/A' }}</td>
        </tr>
        <tr>
            <th>Inspector / User</th>
            <td>
                {# Try to find a user name from the available columns #}
                {% if inspection.driver_loader_name %}
                    {{ inspection.driver_loader_name }}
                {% elif inspection.inspected_by %}
                    {{ inspection.inspected_by }}
                {% elif inspection.person_completing %}
                    {{ inspection.person_completing }}
                {% else %}
                    <span style="color: #ccc;">N/A</span>
                {% endif %}
            </td>
        </tr>
    </table>
</div>

<div class="card">
    <h3>Attachments ({{ attachments|length }})</h3>
    <table>
        <thead>
            <tr>
                <th>Filename</th>
                <th>Status</th>
                <th>Size</th>
                <th>Time</th>
                <th>Validation</th>
            </tr>
        </thead>
        <tbody>
            {% for att in attachments %}
            <tr>
                <!-- Truncate filename if too long -->
                <td title="{{ att.filename }}">
                    {{ att.filename[:50] }}{{ '...' if att.filename|length > 50 else '' }}
                </td>
                <td>
                    {% set status_class = {
                        'downloaded': 'success',
                        'pending': 'info',
                        'failed': 'danger',
                        'skipped': 'warning'
                    }.get(att.attachment_status, 'secondary') %}
                    <span class="badge {{ status_class }}">{{ att.attachment_status }}</span>
                </td>
                
                <!-- FIX: Check if file_size_bytes exists before math -->
                <td>
                    {% if att.file_size_bytes %}
                        {{ "%.2f"|format(att.file_size_bytes / 1024 / 1024) }} MB
                    {% else %}
                        <span style="color: #ccc;">-</span>
                    {% endif %}
                </td>
                
                <!-- FIX: Check if duration exists -->
                <td>
                    {% if att.download_duration_seconds %}
                        {{ "%.1f"|format(att.download_duration_seconds) }}s
                    {% else %}
                        <span style="color: #ccc;">-</span>
                    {% endif %}
                </td>
                
                <td>
                    {% if att.attachment_validation_status == 'valid' %}
                        <span class="badge success">Valid</span>
                    {% elif att.attachment_validation_status %}
                        <span class="badge warning">{{ att.attachment_validation_status }}</span>
                    {% else %}
                        <span style="color: #ccc;">-</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" style="text-align: center; color: #7f8c8d; padding: 1rem;">No attachments found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if errors %}
<div class="card" style="border-top: 3px solid #e74c3c;">
    <h3 style="color: #e74c3c;">Processing Errors</h3>
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Message</th>
            </tr>
        </thead>
        <tbody>
            {% for error in errors %}
            <tr>
                <td style="white-space: nowrap;">{{ error.created_at.strftime('%H:%M:%S') }}</td>
                <td style="color: #c0392b;">{{ error.error_message }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div style="margin-top: 2rem;">
    <a href="{{ url_for('inspections') }}" class="btn btn-secondary">‚Üê Back to Search</a>
</div>
{% endblock %}