{% extends "base.html" %}

{% block title %}Dashboard - Noggin Processor{% endblock %}

{% block content %}
<div class="stats-grid">
    {% set status_config = {
        'complete': ('stat-success', 'Complete'),
        'pending': ('stat-info', 'Pending'),
        'failed': ('stat-danger', 'Failed'),
        'partial': ('stat-warning', 'Partial'),
        'api_error': ('stat-danger', 'API Error'),
        'csv_imported': ('stat-secondary', 'CSV Imported'),
        'interrupted': ('stat-warning', 'Interrupted')
    } %}
    
    {% for status, count in stats.items() %}
        {% set config = status_config.get(status, ('stat-secondary', status|upper)) %}
        <div class="stat-card {{ config[0] }}">
            <div class="stat-label">{{ config[1] }}</div>
            <div class="stat-number">{{ count }}</div>
        </div>
    {% endfor %}
</div>

<div class="card mt-4">
    <div class="card-body">
        <h2 class="h5 mb-3">Records by Object Type</h2>
        <div class="d-flex gap-2 flex-wrap">
            {% for item in type_stats %}
                <div class="object-type-pill">
                    <span class="type-name">{{ item.object_type }}</span>
                    <span class="type-count">{{ item.count }}</span>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h2 class="h5 mb-3">Today's Activity</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Processed</div>
                <div class="stat-number">{{ today_stats.total_today or 0 }}</div>
            </div>
            <div class="stat-card stat-success">
                <div class="stat-label">Completed</div>
                <div class="stat-number">{{ today_stats.completed_today or 0 }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Success Rate</div>
                <div class="stat-number">
                    {% if today_stats.total_today and today_stats.total_today > 0 %}
                        {{ "%.1f"|format((today_stats.completed_today / today_stats.total_today) * 100) }}%
                    {% else %}
                        0%
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h2 class="h5 mb-3">Recent Activity</h2>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Reference / ID</th>
                        <th>User / Team</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Attachments</th>
                        <th>Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in recent %}
                    <tr>
                        <td>
                            <strong>{{ item.noggin_reference or item.tip }}</strong>
                            
                            {% if item.has_unknown_hashes %}
                                <span title="Unknown Hashes" class="cursor-help text-warning">
                                    <i class="fas fa-question-circle"></i>
                                </span>
                            {% endif %}
                            
                            {% if item.retry_count and item.retry_count > 0 %}
                                <span class="badge badge-status-warning ms-1">R:{{ item.retry_count }}</span>
                            {% endif %}
                            
                            <br>
                            <small class="text-muted">{{ item.object_type }}</small>
                        </td>
                        
                        <td>
                            <div class="fw-medium">
                                {% if item.derived_user %}
                                    {{ item.derived_user }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </div>
                            
                            <small class="text-muted">
                                {% if item.team %}
                                    {{ item.team }}
                                {% elif item.department %}
                                    {{ item.department }}
                                {% endif %}
                            </small>
                        </td>

                        <td>{{ item.inspection_date.strftime('%d-%m-%Y') if item.inspection_date else '' }}</td>
                        
                        <td>
                            <span class="badge badge-status-{{ item.processing_status }}">{{ item.processing_status }}</span>
                        </td>

                        <td>
                            {% if item.total_attachments and item.total_attachments > 0 %}
                                {{ item.completed_attachment_count or 0 }}<span class="text-muted">/{{ item.total_attachments }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        
                        <td>{{ item.updated_at.strftime('%H:%M') if item.updated_at else 'N/A' }}</td>
                        
                        <td>
                            <a href="{{ url_for('inspection_detail', tip=item.tip) }}" class="btn btn-primary btn-sm">View</a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">No recent activity found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
